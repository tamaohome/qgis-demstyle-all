# -*- coding: utf-8 -*-
"""
/***************************************************************************
 DEMStyleAllDialog
                                 A QGIS plugin
 DEMスタイル一括設定
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2026-01-26
        git sha              : $Format:%H$
        copyright            :
        email                :

 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

from __future__ import annotations

import os
from typing import override

from qgis.PyQt.QtCore import Qt
from qgis.core import QgsPointXY
from qgis.core import QgsRaster
from qgis.gui import QgsMapTool
from qgis.gui import QgsMapToolEmitPoint
from qgis.PyQt import uic
from qgis.PyQt import QtWidgets

from .settings import DialogSettings

# This loads your .ui file so that PyQt can populate your plugin with the elements from Qt Designer
FORM_CLASS, _ = uic.loadUiType(
    os.path.join(os.path.dirname(__file__), "demstyle_all_dialog_base.ui")
)


class DEMStyleAllDialog(QtWidgets.QDialog, FORM_CLASS):
    def __init__(self, iface):
        """Constructor."""
        super(DEMStyleAllDialog, self).__init__(parent=None)
        self.iface = iface
        self.settings = DialogSettings()
        self.setupUi(self)

        self.settings.restore_dialog_state(self)  # ダイアログ設定を復元

        # setHeightButtonクリック時の処理を接続
        self.setHeightButton.clicked.connect(self.on_set_height_clicked)

    def on_set_height_clicked(self):
        """地図キャンバスのクリック座標で標高値を取得しSpinBox等に反映"""

        # QtWidgets.QMessageBox.information(
        #     self, "地図クリック", "標高を取得したい地点を地図上でクリックしてください。"
        # )
        self._canvas = self.iface.mapCanvas()
        self._prev_maptool = self._canvas.mapTool()
        self._point_tool = QgsMapToolEmitPoint(self._canvas)
        self._point_tool.canvasClicked.connect(self._on_canvas_clicked)
        self._canvas.setMapTool(self._point_tool)

    def _on_canvas_clicked(self, point, button):
        if button != Qt.LeftButton:
            return

        # 標高取得後にダイアログを最前面に表示
        self.raise_()
        self.activateWindow()

        layer = self.iface.activeLayer()

        # モード解除
        self._canvas.setMapTool(self._prev_maptool)
        self._point_tool.canvasClicked.disconnect(self._on_canvas_clicked)
        del self._point_tool
        del self._prev_maptool
        del self._canvas

        if layer is None:
            QtWidgets.QMessageBox.warning(
                self, "レイヤ未選択", "QGISのレイヤツリーでレイヤを選択してください。"
            )
            return

        if hasattr(layer, "dataProvider") and hasattr(layer, "extent"):
            provider = layer.dataProvider()
            ident = provider.identify(point, QgsRaster.IdentifyFormatValue)
            if ident.isValid():
                results = ident.results()
                if results:
                    value = list(results.values())[0]
                    self.midHeightSpinBox.setValue(int(value))
                    return

        QtWidgets.QMessageBox.warning(
            self, "標高取得失敗", "標高値の取得に失敗しました。"
        )

    @override
    def closeEvent(self, event):
        """ウィンドウを閉じる前に設定を保存"""
        self.settings.save_dialog_state(self)
        event.accept()


class PointAndElevationTool(QgsMapTool):
    """標高取得用MapTool"""

    def __init__(self, canvas, iface):
        super().__init__(canvas)
        self.canvas = canvas
        self.iface = iface

    def canvasPressEvent(self, e):
        # クリックされた座標を取得（画面座標から地図座標へ変換）
        point = self.toMapCoordinates(e.pos())

        # イベントをここで終了させ、QGISデフォルト挙動を上書き
        e.accept()

        # 標高（ラスタ値）取得処理の呼び出し
        self.get_elevation(point)

    def get_elevation(self, point):
        layer = self.iface.activeLayer()
        if not layer or layer.type() != layer.RasterLayer:
            return

        # 第1バンドの値を取得
        res = layer.dataProvider().identify(point, QgsRaster.IdentifyFormatValue)
        if res.isValid():
            val = res.results().get(1)  # バンド1の値
            self.iface.messageBar().pushMessage(
                "情報", f"座標: {point.x():.3f}, {point.y():.3f} / 標高: {val}", level=0
            )
